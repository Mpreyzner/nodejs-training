#!/usr/bin/env node

'use strict';

const app = require('../app/user_app.js')
    , debug = require('debug')('intern2-node-register-kornel:server')
    , http = require('http')
    , async = require('async')

    , MongoDb = require('../lib/mongo_db')
    , mongoDb = new MongoDb({connectionUri: process.env.MONGODB_URI, modelDir: `../models`})

    , port = parseInt(process.env.PORT || '3000', 10)
    , server = http.createServer(app)
    , RabbitMq = require('../lib/rabbit_mq.js')
    , rabbitMq = new RabbitMq({connectionUri: process.env.RABBITMQ_URI})
    , _ = require('lodash')

;

app.set('port', port);
app.set('db', mongoDb);
app.set('rabbitMq', rabbitMq);

const nodemailer = require('nodemailer');
let smtpuri = process.env.SMTP_URI;
let options = {service: smtpuri};
let defaults = {};

let transporter = nodemailer.createTransport(options, defaults);

async.waterfall([
    // INIT MONGODB CONNECTION
    (next) => {
        mongoDb.init((err) => {
            if (err) {
                console.error(`MongoDb initialization error: ${err.message}`);
                return next(err);
            }

            next(null);
        });
    },

    (next) => {
        // INIT RABBIT CONNECTION
        rabbitMq.init((err) => {
            if (err) {
                console.error(`rabbitMq initialization error: ${err.message}`);
                return next(err);
            }

            next(null);
        });
    },
    (next) => {

        const params = {
            exchange: {
                name: `ex-events-${_.snakeCase(process.env.TEAM_NAME)}`,
                type: 'topic'
            }
        };
        let publisher = rabbitMq.getPublisher(params, next);
        next(publisher);

    },
    (publisher, next) => {
        publisher.publish(
            'user_registration_event',
            _.pick(req.body, ['email', 'firstname', 'lastname']), {
                deliveryMode: 2,
                mandatory: true
            }, (err) => {
                return next(err);
            });
    },

    // INIT HTTP SERVER
    (next) => {
        server.listen(port);

        server.once('error', (err) => {
            if (err) {
                console.error(`Http server initialization error: ${err.message}`);
                return next(err);
            }

            next(null);
        });

        server.once('listening', next);
    }

], (err) => {
    if (err) {
        process.exit(1);
    }

    console.log(`USER_API http server initialized - listening @ :${port}`);
});
